# -*- coding: utf-8 -*-
"""Atlas Cod. Success

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1aLmu9j2UnZBYNBcRktl4gAneEIEx-kzl

# Carga de librer칤as
"""

# Carga de librer칤as
# Instalar si es necesario (SE DEMORA 7 MINUTOS en ejecutar)
install.packages(c("readr", "dplyr", "randomForest", "ggplot2", "caret"))

# Cargar librer칤as
library(readr)
library(dplyr)
library(randomForest)
library(ggplot2)
library(caret)

"""# Main (C칩digo principal)"""

# Main (C칩digo principal)
# Leer CSV
df <- read_csv("AtlasRetail_PowerBI_Final_Limpio.csv", locale = locale(decimal_mark = ","))

# Renombrar variables clave
names(df)[names(df) == "Margen_(%)"] <- "Margen_pct"
names(df)[names(df) == "Rentabilidad_(%)"] <- "Rentabilidad_pct"

# Main (C칩digo principal)
df <- read_csv("AtlasRetail_PowerBI_Final_Limpio.csv", locale = locale(decimal_mark = ","))

names(df)[names(df) == "Rentabilidad_(%)"] <- "Rentabilidad_pct"
names(df)[names(df) == "Margen_(%)"] <- "Margen_pct"

df <- df %>%
  mutate(
    Rentabilidad_pct = as.numeric(gsub(",", ".", Rentabilidad_pct)),
    Margen_pct = as.numeric(gsub(",", ".", Margen_pct)),
    Costo_envio = as.numeric(gsub(",", ".", Costo_de_envio)),
    Descuento = as.numeric(gsub(",", ".", Descuento)),
    Precio_unitario = as.numeric(gsub(",", ".", Precio_Unitario_de_Venta)),
    Costo_total = as.numeric(gsub(",", ".", Costo_Total)),
    Cantidad = as.numeric(Cantidad),
    Regi칩n = as.factor(Region),
    Categor칤a = as.factor(Categoria),
    Sub_Categor칤a = as.factor(Sub_Categoria),
    Prioridad = as.factor(Prioridad_de_orden)
  ) %>%
  select(Rentabilidad_pct, Margen_pct, Costo_envio, Descuento, Precio_unitario,
         Costo_total, Cantidad, Regi칩n, Categor칤a, Sub_Categor칤a, Prioridad) %>%
  na.omit()

# 2. Crear variables derivadas
df <- df %>%
  mutate(
    Margen_vs_Precio_unitario = ifelse(Precio_unitario == 0, 0, Margen_pct / Precio_unitario),
    Ratio_descuento_costo = ifelse(Costo_envio == 0, 0, Descuento / Costo_envio)
  )

# 3. Descuento promedio por categor칤a
prom_descuento <- df %>%
  group_by(Categor칤a) %>%
  summarise(Desc_por_categoria = mean(Descuento, na.rm = TRUE))

df <- left_join(df, prom_descuento, by = "Categor칤a")

# 4. Filtrar outliers extremos de Rentabilidad
df <- df %>%
  filter(Rentabilidad_pct > -100, Rentabilidad_pct < 150)

"""# Fase de entrenamiento del modelo"""

# Fase de entrenamiento del modelo
# 5. Divisi칩n entrenamiento / prueba
set.seed(42)
trainIndex <- createDataPartition(df$Rentabilidad_pct, p = 0.8, list = FALSE)
trainData <- df[trainIndex, ]
testData <- df[-trainIndex, ]

# Fase de entrenamiento del modelo
# 6. Entrenar modelo con nuevas variables (se demoro 27 minutos)
modelo_rf <- randomForest(
  Rentabilidad_pct ~ Costo_envio + Descuento + Precio_unitario + Costo_total + Cantidad +
    Regi칩n + Categor칤a + Sub_Categor칤a + Prioridad +
    Margen_vs_Precio_unitario + Ratio_descuento_costo + Desc_por_categoria,
  data = trainData,
  ntree = 300,
  mtry = 4,
  importance = TRUE
)

"""# Evaluaci칩n del modelo"""

# Evaluaci칩n del modelo
# 7. Evaluaci칩n del modelo
pred <- predict(modelo_rf, newdata = testData)
rsq <- cor(pred, testData$Rentabilidad_pct)^2
rmse <- sqrt(mean((pred - testData$Rentabilidad_pct)^2))

cat("游꿢 R FINAL:", rsq, "\n游늴 RMSE FINAL:", rmse, "\n")

# Evaluaci칩n del modelo
varImpPlot(modelo_rf, main = "Importancia de Variables - Modelo Optimizado")

# Evaluaci칩n del modelo
# Calcular el RMSE relativo
rango_rentabilidad <- max(df$Rentabilidad_pct) - min(df$Rentabilidad_pct)
rmse_relativo <- rmse / rango_rentabilidad

cat("游늺 RMSE Relativo:", round(rmse_relativo, 4), "\n")

# Evaluaci칩n del modelo
# Predicci칩n con test set (validaci칩n externa)
pred <- predict(modelo_rf, newdata = testData)

# M칠tricas con test set
rsq_test <- cor(pred, testData$Rentabilidad_pct)^2
rmse_test <- sqrt(mean((pred - testData$Rentabilidad_pct)^2))

cat("游빍 Test Set - R:", round(rsq_test, 4), "\n")
cat("游빍 Test Set - RMSE:", round(rmse_test, 4), "\n")

# Evaluaci칩n del modelo
# OOB: Out-of-Bag error
rmse_oob <- sqrt(modelo_rf$mse[modelo_rf$ntree])  # RMSE = sqrt del 칰ltimo MSE
rsq_oob <- modelo_rf$rsq[modelo_rf$ntree]         # R OOB del 칰ltimo 치rbol

cat("游 OOB - RMSE:", round(rmse_oob, 4), "\n")
cat("游 OOB - R:", round(rsq_oob, 4), "\n")

| M칠trica         | 쯈u칠 mide?                                    | 쯈u칠 esperas ver?             |
| --------------- | --------------------------------------------- | ----------------------------- |
| RMSE Relativo   | Qu칠 tan grande es el error comparado al rango | Ideal < 0.10                  |
| RMSE (Test Set) | Precisi칩n real con datos no vistos            | Mientras m치s bajo, mejor      |
| R (Test Set)   | Porcentaje de variabilidad explicada          | > 0.90                        |
| RMSE / R OOB   | Validaci칩n cruzada interna del modelo         | Debe ser parecido al test set |

"""# Predicci칩n de Rentabilidad"""

# Predicci칩n de Rentabilidad
# Categor칤as validad a ingresar, elija una por concepto:
levels(df$Regi칩n)
levels(df$Categor칤a)
levels(df$Sub_Categor칤a)
levels(df$Prioridad)

# Predicci칩n de Rentabilidad
# Categor칤as y sus Sub_Categor칤as v치lidas:

# Furniture: Chairs, Tables, Bookcases, Furnishings

# Office Supplies: Binders, Paper, Labels, Storage, Supplies, Art

# Technology: Phones, Accessories, Machines, Copiers

# Predicci칩n de Rentabilidad
# Valores estimados de referencia:
df %>%
  group_by(Categor칤a) %>%
  summarise(Desc_por_categoria = mean(Descuento, na.rm = TRUE))

# Predicci칩n de Rentabilidad
# Para calcular: margen_vs_precio_unitario y ratio_descuento_costo, ingrese los datos deseados
descuento <- 0.18
costo_envio <- 2000
precio_unitario <- 150
costo_total <- 40000
cantidad <- 8


# C치lculo autom치tico de variables derivadas
margen_vs_precio_unitario <- (costo_total - costo_envio) / (precio_unitario * cantidad)
ratio_descuento_costo <- descuento / costo_envio

cat("游빑 Margen vs Precio Unitario:", round(margen_vs_precio_unitario, 4), "\n")
cat("游늴 Ratio Descuento / Costo:", format(round(ratio_descuento_costo, 6), scientific = FALSE), "\n")

# Predicci칩n de Rentabilidad
# Ejemplo: nuevo dato (puedes cambiar los valores)
nuevo_dato <- data.frame(
  Costo_envio = 2000,
  Descuento = 0.18,
  Precio_unitario = 150,
  Costo_total = 40000,
  Cantidad = 8,
  Regi칩n = factor("Canada", levels = levels(df$Regi칩n)),
  Categor칤a = factor("Technology", levels = levels(df$Categor칤a)),
  Sub_Categor칤a = factor("Machines", levels = levels(df$Sub_Categor칤a)),
  Prioridad = factor("High", levels = levels(df$Prioridad)),
  Margen_vs_Precio_unitario = 31.6667,       # Calculado o estimado
  Ratio_descuento_costo = 0.00009 ,         # Descuento / Costo_envio
  Desc_por_categoria = 0.1091221             # Promedio seg칰n categor칤a
)

# Predicci칩n
pred_rentabilidad <- predict(modelo_rf, newdata = nuevo_dato)

# Mostrar resultado
cat("游댩 Predicci칩n de Rentabilidad (%) =", round(pred_rentabilidad, 2), "%\n")

"""# Codigos necesarios para crear la interfaz en Visual Studio Code con Shiny"""

# Codigos necesarios para crear la interfaz en Visual Studio Code con Shiny
library(tidyverse)

# 1. Leer el CSV original
df <- read_csv("AtlasRetail_PowerBI_Final_Limpio.csv", locale = locale(decimal_mark = ","))

# Codigos necesarios para crear la interfaz en Visual Studio Code con Shiny
# 2. Renombrar y convertir variables
df <- df %>%
  rename(
    Rentabilidad_pct = `Rentabilidad_(%)`,
    Margen_pct = `Margen_(%)`
  ) %>%
  mutate(
    Rentabilidad_pct = as.numeric(gsub(",", ".", Rentabilidad_pct)),
    Margen_pct = as.numeric(gsub(",", ".", Margen_pct)),
    Costo_envio = as.numeric(gsub(",", ".", Costo_de_envio)),
    Descuento = as.numeric(gsub(",", ".", Descuento)),
    Precio_unitario = as.numeric(gsub(",", ".", Precio_Unitario_de_Venta)),
    Costo_total = as.numeric(gsub(",", ".", Costo_Total)),
    Cantidad = as.numeric(Cantidad),
    Regi칩n = as.factor(Region),
    Categor칤a = as.factor(Categoria),
    Sub_Categor칤a = as.factor(Sub_Categoria),
    Prioridad = as.factor(Prioridad_de_orden)
  ) %>%
  na.omit()

# 3. Crear nuevas variables derivadas
df <- df %>%
  mutate(
    Margen_vs_Precio_unitario = ifelse(Precio_unitario == 0, 0, Margen_pct / Precio_unitario),
    Ratio_descuento_costo = ifelse(Costo_envio == 0, 0, Descuento / Costo_envio)
  )

# 4. Agregar descuento promedio por categor칤a
prom_descuento <- df %>%
  group_by(Categor칤a) %>%
  summarise(Desc_por_categoria = mean(Descuento, na.rm = TRUE))

df <- left_join(df, prom_descuento, by = "Categor칤a")

# 5. Filtrar outliers extremos
df <- df %>%
  filter(Rentabilidad_pct > -100, Rentabilidad_pct < 150)

# 6. Seleccionar solo las columnas que usa el modelo
df_final <- df %>%
  select(Rentabilidad_pct, Costo_envio, Descuento, Precio_unitario, Costo_total, Cantidad,
         Regi칩n, Categor칤a, Sub_Categor칤a, Prioridad,
         Margen_vs_Precio_unitario, Ratio_descuento_costo, Desc_por_categoria)

# 7. Guardar el dataset limpio
write_csv(df_final, "dataset_final_para_visual_studio_code_limpio.csv")

# Codigos necesarios para crear la interfaz en Visual Studio Code con Shiny
names(df_final)

# Codigos necesarios para crear la interfaz en Visual Studio Code con Shiny
# Guardar el modelo como archivo RDS
saveRDS(modelo_rf, file = "modelo_rf.rds")